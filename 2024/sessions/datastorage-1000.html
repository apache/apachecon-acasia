<!DOCTYPE HTML>

<html>
<head>
    <title>Optimization for Reducing Compute Cost of SparkSQL in ByteDance - CommunityOverCode Asia 2024 - Powered by ALC-Beijing</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'unsafe-inline' 'unsafe-eval' *; style-src 'unsafe-inline' *; img-src * data:; font-src * data:; connect-src *; frame-src *;">

    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <meta property='og:title' content='Optimization for Reducing Compute Cost of SparkSQL in ByteDance'/>
    <meta property='og:url' content='https://asia.communityovercode.org/2024'/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <base href="/2024"/>
    
    
    <link rel="icon" type="image/png" href="images/favicon.ico">
    <link rel="stylesheet" href="/2024/css/bootstrap.min.css">
    <link rel="stylesheet" href="/2024/css/style.css"/>

    
    <link rel="stylesheet" href="/2024/scss/main.min.f327fac657d730f3f1b9f16418e56111a1b2dc2bb77a5c8ef7e2e089db2941bc.css">
    
    <link rel="stylesheet" href="/2024/scss/acasia2021.min.4d8823c67361eb6bcc127980e7d7abc34545374e41cd842aa752bfe6650f31b4.css">

    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.dropotron.min.js"></script>
    
    
    <noscript>
        
    </noscript>
    <link rel="stylesheet" href="css/search.css"/>
    
</head>

<body>


<div class="wrapper style1">

    
<div id="header">
    <div class="container">
        
        
<nav id="nav" class="navbar navbar-dark navbar-expand-lg bg-transparent">
  <div class="container py-1">
    <div class="btn-wrap d-flex align-items-center justify-content-between">
        
            <a href="index.html" class="navbar-brand">
                <img class="logo-img" src="/2024/images/cocasia2024-logo.png" height="120" width="200px" ALIGN=CENTER>
            </a>
        
         <button
            onclick="changeMenuBg()"
            class="navbar-toggler" 
            type="button"
            data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
    <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
        <ul class="navbar-nav">
            
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        Home
                    </a>
                </li>
            
            
            
                <li class="nav-item">
                    
                    <a href="/2024/schedule.html" class="nav-link">Schedule</a>
                </li>
            
                <li class="nav-item">
                    
                    <a href="/2024/sponsor.html" class="nav-link">Sponsor</a>
                </li>
            
                <li class="nav-item">
                    
                    <a href="/2024/guide/visa_letter_request.html" class="nav-link">Guide</a>
                </li>
            
                <li class="nav-item">
                    
                    <a href="/2024/venue_travel/venue.html" class="nav-link">Venue &#43; Travel</a>
                </li>
            
                <li class="nav-item">
                    
                    <a href="/2024/conduct.html" class="nav-link">Code of Conduct</a>
                </li>
            
            
                
                    <li class="nav-item">
                        <a href="/2024/zh/sessions/datastorage-1000.html" class="nav-link" >中文</a>
                    </li>
                
            
            
            
        </ul>
    </div>
  </div>
</nav>
<script>
    const isHome = "false";
    function changeMenuBg () {
        const nav = document.getElementById('nav');
        if (isHome !== 'true') {
            return;
        }
        if (nav.classList.contains('bg-custom')) {
            nav.classList.remove('bg-custom');
            nav.classList.add('bg-transparent');
        } else {
            nav.classList.add('bg-custom');
            nav.classList.remove('bg-transparent');
        }
    }

</script>

    </div>
</div>

    
    <div id="main" class="wrapper style4 page-session">

        
        <div id="content" class="container">
            <section>
                <header class="major">
                    <h3>Optimization for Reducing Compute Cost of SparkSQL in ByteDance</h3>
                    <h4>Hongnan Gan</h4>
                    Chinese Session  2024-07-27 14:30 GMT&#43;8&nbsp;
                    
                    <a class="label" href="/2024/tracks/datastorage.html">#datastorage</a></li>
                </header>

                <p>ByteDance employs SparkSQL as one of the primary tools for ETL. Through analysis of online tasks, it was discovered that three major factors contribute to the degradation of Spark job performance: shuffling large volumes of data, scanning numerous small files, and inefficient speculative execution. Shuffling large volumes of data may lead to issues such as network congestion, IO bottlenecks, and affecting the stability of the Shuffle Service. Reading numerous small files increases data transmission overhead and memory usage. Inefficient speculative execution frequently initiates and kills backup tasks, wasting cluster resources and impacting the scheduling of other tasks. These factors significantly increase computational costs.</p>
<p>We optimized Shuffle using two main techniques: Bucketing and ZSTD Shuffle. Firstly, we significantly enhanced Bucket optimization based on the open-source SparkSQL. This includes covering more Exchange elimination scenarios, improving usability, and becoming more adaptive. We also constructed a Bucket recommendation system to automatically identify which tables could reduce Shuffle data when converted to Bucket. In ODS scenarios, the recommended Bucket optimization can reduce Shuffle data by up to 99.9% and save up to 58% of computational resources. Secondly, we changed the compression algorithm of Shuffle data from LZ4 to ZSTD, resulting in a noticeable increase in compression ratio, reducing Shuffle data by over 40%.</p>
<p>We designed and implemented a Shuffle-based small file consolidation feature to prevent the generation of small files, thereby eliminating the need for downstream tasks to scan numerous small files. This functionality achieves file consolidation by introducing a Shuffle before writing to the table and controlling Shuffle parallelism, thereby avoiding secondary HDFS read-write operations. Additionally, we utilized the AQE (Adaptive Query Execution) framework to optimize Shuffle Read, preventing data skew.</p>
<p>To mitigate the issues caused by inefficient speculative execution, we first analyzed the profiles of all online tasks and found that a significant number of tasks initiated for speculative execution were ultimately terminated, resulting in considerable waste of cluster resources. Subsequently, we introduced Efficient Speculation optimization, which determines whether to initiate speculative execution based on the speed of data processing, thereby avoiding speculative execution initiation due to data skew (as speculative execution cannot address such cases). Finally, we appropriately increased the threshold for initiating speculative execution, further reducing the waste of computational resources caused by speculative execution. After optimization, the number of speculative execution tasks decreased by 15%, and computational resource consumption decreased by 9%.</p>
<h3 id="speakers">Speakers:</h3>
<p><img src="https://sessionize.com/image/c52a-400o400o1-fqHUaN3MbFjUnx1NxULM9c.jpg" width="200" /><br>Hongnan Gan:  ByteDance Senior R&amp;D Engineer,</p>
<ul>
<li>BS and MEng Degree of Fudan University</li>
<li>SparkSQL kernel developer in ByteDance</li>
<li>Interested in SQL optimizing
<br><br></li>
</ul>


                <div style="position:relative; padding-bottom:50%; width:90%; height:0">
                    <iframe src=""  class="iframe_video" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position:absolute; height: 100%; width: 100%;"></iframe>
                </div>

            </section>
        </div>
    </div>

    

<div id="footer">
  <section class="container">
    <header class="major">
      <h2>Connect with us</h2>
    </header>
    <div class="d-flex align-items-center justify-content-between mx-auto mb-5" style="max-width: 512px">
      <a href="https://www.facebook.com/ApacheSoftwareFoundation/">
        <img width="64" src="/2024/images/icon-facebook-128.png">
      </a>
      <a href="https://twitter.com/ApacheCon">
        <img width="64" src="/2024/images/icon-twitter-x-128.png">
      </a>
      <a href="http://s.apache.org/apachecon-slack">
        <img width="64" src="/2024/images/icon-slack-128.png">
      </a>
    </div>
		<p>CommunityOverCode operates under the terms of the <a href="https://www.apache.org/foundation/policies/conduct.html">Apache Software Foundation Code of Conduct</a>. </p>
    <p class="byline mb-0">Copyright 2024, <a href="https://www.apache.org/">The Apache Software Foundation</a>, Licensed under the Apache License, Version 2.0. <br />Apache and the Apache feather logo are trademarks of The Apache Software Foundation.</div>
    </section>
</div>
</div>


</body>
</html>
